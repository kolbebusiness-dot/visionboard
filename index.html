<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" href="icon.jpg">
    <title>Vision Board App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            position: relative;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
        }

        body.fullscreen-active {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 60px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .hamburger {
            width: 30px;
            height: 25px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .hamburger span {
            width: 100%;
            height: 3px;
            background: #fff;
            transition: 0.3s;
        }

        .side-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            max-width: 80vw;
            height: 100vh;
            background: rgba(30, 30, 30, 0.98);
            backdrop-filter: blur(10px);
            transition: 0.3s;
            z-index: 200;
            padding-top: 80px;
            border-left: 1px solid #444;
        }

        .side-menu.active {
            right: 0;
        }

        .menu-item {
            padding: 20px 30px;
            cursor: pointer;
            transition: 0.2s;
            border-bottom: 1px solid #444;
            font-size: 18px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 150;
        }

        .overlay.active {
            display: block;
        }

        .main-content {
            padding-top: 80px;
            min-height: 100vh;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        .page {
            display: none;
            width: 100%;
        }

        .page.active {
            display: block;
        }

        .controls {
            padding: 15px;
            background: rgba(30, 30, 30, 0.8);
            margin: 15px;
            border-radius: 10px;
            width: calc(100% - 30px);
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #aaa;
        }

        select, input[type="text"], input[type="number"], button {
            width: 100%;
            padding: 12px;
            background: rgba(50, 50, 50, 0.9);
            border: 1px solid #555;
            color: #fff;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        button {
            background: #4a90e2;
            cursor: pointer;
            transition: 0.2s;
            border: none;
            touch-action: manipulation;
        }

        button:hover, button:active {
            background: #5aa0f2;
        }

        button.delete {
            background: #e24a4a;
        }

        button.delete:hover, button.delete:active {
            background: #f25a5a;
        }

        .grid-container {
            width: calc(100% - 30px);
            margin: 15px;
            background: #000;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 10px;
            display: grid;
            gap: 10px;
            position: relative;
            align-content: start;
        }

        .fullscreen-board-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 45px;
            height: 45px;
            background: rgba(74, 144, 226, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            font-size: 20px;
            border: none;
            color: white;
            touch-action: manipulation;
        }

        .vision-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .history-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-item {
            aspect-ratio: 1;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: move;
            touch-action: pan-y;
        }

        .grid-item.dragging {
            opacity: 0.5;
            z-index: 1000;
        }

        .grid-item.drag-over {
            border-color: #4a90e2;
            background: rgba(74, 144, 226, 0.1);
        }

        .grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
            user-select: none;
        }

        .grid-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 30px;
            height: 30px;
            background: rgba(226, 74, 74, 0.9);
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            line-height: 1;
            z-index: 10;
            touch-action: manipulation;
        }

        .grid-item .move-left-btn,
        .grid-item .move-right-btn {
            position: absolute;
            bottom: 5px;
            width: 35px;
            height: 35px;
            background: rgba(74, 144, 226, 0.9);
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            line-height: 1;
            z-index: 10;
            touch-action: manipulation;
        }

        .grid-item .move-left-btn {
            left: 5px;
        }

        .grid-item .move-right-btn {
            right: 5px;
        }

        .grid-item.selected .delete-btn,
        .grid-item.selected .move-left-btn,
        .grid-item.selected .move-right-btn {
            display: flex;
        }

        .grid-item.selected {
            border-color: #4a90e2;
        }

        .history-container {
            padding: 15px;
            width: 100%;
        }

        .history-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(30, 30, 30, 0.8);
            padding: 15px;
            padding-top: 40px;
            border-radius: 10px;
            width: 100%;
            position: relative;
        }

        .history-row-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: rgba(226, 74, 74, 0.9);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            line-height: 1;
            border: none;
            padding: 0;
        }

        .history-col-age {
            flex: 3;
            min-width: 0;
        }

        .history-col-images {
            flex: 9;
            min-width: 0;
        }

        .age-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .age-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .age-input-group label {
            font-size: 12px;
            color: #aaa;
        }

        .age-input-group input {
            margin-bottom: 0;
        }

        .add-row-btn {
            margin: 15px;
            width: calc(100% - 30px);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 10px;
            max-width: 90vw;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #aaa;
        }

        .close-modal:hover {
            color: #fff;
        }

        input[type="file"] {
            width: 100%;
            padding: 10px;
            background: rgba(50, 50, 50, 0.9);
            border: 1px solid #555;
            color: #fff;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .row-delete-btn {
            display: none;
        }

        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            z-index: 500;
            background: #000;
            display: none;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .fullscreen-overlay.active {
            display: block;
        }

        .fullscreen-grid {
            width: 100%;
            height: auto;
            padding: 60px 10px 10px 10px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            align-content: start;
        }

        .fullscreen-grid .grid-item {
            aspect-ratio: 1;
            cursor: pointer;
            touch-action: pan-y;
        }

        .fullscreen-grid .grid-item img {
            pointer-events: none;
            user-select: none;
        }

        .fullscreen-close {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: rgba(226, 74, 74, 0.9);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            line-height: 1;
            z-index: 510;
            touch-action: manipulation;
        }

        .image-fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            z-index: 600;
            background: #000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .image-fullscreen-overlay.active {
            display: flex;
        }

        .image-fullscreen-overlay img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-fullscreen-close {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: rgba(226, 74, 74, 0.9);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            line-height: 1;
            z-index: 610;
        }

        .current-board-name {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(50, 50, 50, 0.5);
            border-radius: 5px;
            text-align: center;
        }

        .select-board-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .select-board-row select {
            flex: 1;
        }

        .rename-btn {
            width: 40px;
            height: 40px;
            min-width: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 10px;
            background: rgba(70, 70, 70, 0.9);
        }

        .rename-btn:hover, .rename-btn:active {
            background: rgba(90, 90, 90, 0.9);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="pageTitle">Vision Board</h1>
        <div class="hamburger" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <div class="side-menu" id="sideMenu">
        <div class="menu-item" onclick="navigateTo('vision')">Vision</div>
        <div class="menu-item" onclick="navigateTo('history')">History</div>
    </div>

    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

    <div class="main-content">
        <div class="page active" id="visionPage">
            <div class="controls">
                <button onclick="createNewBoard()">Create New Board</button>
                <div class="control-group">
                    <label>Select Board</label>
                    <div class="select-board-row">
                        <select id="boardSelect" onchange="loadBoard()">
                            <option value="">Select a board...</option>
                        </select>
                        <button class="rename-btn" onclick="renameBoard()" title="Rename Board">✏️</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Add Images</label>
                    <input type="file" id="imageUpload" accept="image/*" multiple onchange="addImages(event)">
                </div>
                <button onclick="saveBoard()">Save Board</button>
                <button class="delete" onclick="deleteBoard()">Delete Current Board</button>
            </div>
            <div class="grid-container vision-grid" id="visionGrid">
                <button class="fullscreen-board-btn" onclick="showFullscreenVision()">⛶</button>
            </div>
        </div>

        <div class="page" id="historyPage">
            <div class="controls">
                <h2>History Timeline</h2>
            </div>
            <div class="history-container" id="historyContainer"></div>
            <button class="add-row-btn" onclick="addHistoryRow()">Add New Row</button>
        </div>
    </div>

    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <div class="fullscreen-close" onclick="closeFullscreenVision()">×</div>
        <div class="fullscreen-grid" id="fullscreenGrid"></div>
    </div>

    <div class="image-fullscreen-overlay" id="imageFullscreenOverlay" onclick="closeImageFullscreen()">
        <div class="image-fullscreen-close" onclick="closeImageFullscreen()">×</div>
        <img id="imageFullscreenImg" src="" alt="" onclick="event.stopPropagation()">
    </div>

    <div class="modal" id="selectBoardModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSelectBoardModal()">&times;</span>
            <h2>Select Board</h2>
            <div class="control-group">
                <label>Choose Board</label>
                <select id="historyBoardSelect">
                    <option value="">Select a board...</option>
                </select>
            </div>
            <button onclick="confirmBoardSelection()">Continue</button>
            <button onclick="closeSelectBoardModal()">Cancel</button>
        </div>
    </div>

    <script>
        let boards = {};
        let currentBoardId = null;
        let historyRows = [];
        let currentEditingRowIndex = null;
        let selectedImageIndex = -1;

        // Image compression function
        function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Resize if image is too large
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to compressed base64
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Check localStorage usage
        function getStorageUsage() {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length + key.length;
                }
            }
            return total;
        }

        function getStorageUsageMB() {
            return (getStorageUsage() / (1024 * 1024)).toFixed(2);
        }

        function checkStorageSpace() {
            const usageMB = getStorageUsageMB();
            const limitMB = 5; // Most browsers have 5-10MB limit
            
            if (usageMB > limitMB * 0.9) {
                alert('Warning: Storage is almost full (' + usageMB + ' MB used). Consider deleting old boards or images.');
                return false;
            }
            return true;
        }

        function init() {
            loadFromStorage();
            updateBoardSelect();
            renderHistory();
            
            // Show storage usage on startup
            console.log('Storage usage:', getStorageUsageMB(), 'MB');
            checkStorageSpace();
            
            let visionboardId = null;
            for (let id in boards) {
                if (boards[id].name === 'Visionboard') {
                    visionboardId = id;
                    break;
                }
            }
            
            if (!visionboardId) {
                visionboardId = 'board_' + Date.now();
                boards[visionboardId] = {
                    name: 'Visionboard',
                    images: []
                };
                saveToStorage();
            }
            
            currentBoardId = visionboardId;
            updateBoardSelect();
            document.getElementById('boardSelect').value = visionboardId;
            
            loadBoard();
            showFullscreenVision();
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.grid-item') && 
                    !e.target.closest('.delete-btn') && 
                    !e.target.closest('.move-left-btn') && 
                    !e.target.closest('.move-right-btn')) {
                    document.querySelectorAll('#visionGrid .grid-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    selectedImageIndex = -1;
                }
            });
        }

        function updateCurrentBoardDisplay() {
            // Function kept for compatibility but display removed
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('visionBoardData');
                if (saved) {
                    const data = JSON.parse(saved);
                    boards = data.boards || {};
                    historyRows = data.historyRows || [];
                    console.log('✓ Loaded from storage. Boards:', Object.keys(boards).length, 'History rows:', historyRows.length);
                    console.log('Data:', data);
                } else {
                    console.log('No saved data found in localStorage');
                }
            } catch (e) {
                console.error('✗ Error loading from storage:', e);
            }
        }

        function saveToStorage() {
            try {
                const data = {
                    boards: boards,
                    historyRows: historyRows
                };
                const jsonString = JSON.stringify(data);
                localStorage.setItem('visionBoardData', jsonString);
                
                // Verify it was saved
                const verification = localStorage.getItem('visionBoardData');
                if (verification === jsonString) {
                    console.log('✓ Successfully saved to localStorage. Boards:', Object.keys(boards).length, 'History rows:', historyRows.length);
                    console.log('Data:', data);
                } else {
                    console.error('✗ Save verification failed!');
                }
            } catch (e) {
                console.error('✗ Error saving to storage:', e);
                alert('Error saving data: ' + e.message);
            }
        }

        function toggleMenu() {
            document.getElementById('sideMenu').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            if (page === 'vision') {
                document.getElementById('visionPage').classList.add('active');
                document.getElementById('pageTitle').textContent = 'Vision Board';
            } else if (page === 'history') {
                document.getElementById('historyPage').classList.add('active');
                document.getElementById('pageTitle').textContent = 'History';
                renderHistory();
            }
            
            toggleMenu();
        }

        function updateBoardSelect() {
            const select = document.getElementById('boardSelect');
            const historySelect = document.getElementById('historyBoardSelect');
            
            select.innerHTML = '<option value="">Select a board...</option>';
            historySelect.innerHTML = '<option value="">Select a board...</option>';
            
            Object.keys(boards).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = boards[id].name;
                select.appendChild(option);

                const historyOption = option.cloneNode(true);
                historySelect.appendChild(historyOption);
            });
        }

        function createNewBoard() {
            const name = prompt('Enter name for new board:', 'New Board');
            
            if (!name || name.trim() === '') {
                return;
            }
            
            const id = 'board_' + Date.now();
            boards[id] = {
                name: name.trim(),
                images: []
            };
            currentBoardId = id;
            saveToStorage();
            updateBoardSelect();
            document.getElementById('boardSelect').value = id;
            renderGrid();
            alert('New board "' + name.trim() + '" created!');
        }

        function renameBoard() {
            if (!currentBoardId) {
                alert('Please select a board first');
                return;
            }

            const currentName = boards[currentBoardId].name;
            const newName = prompt('Enter new name for board:', currentName);
            
            if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                boards[currentBoardId].name = newName.trim();
                saveToStorage();
                updateBoardSelect();
                document.getElementById('boardSelect').value = currentBoardId;
                renderHistory();
                alert('Board renamed to "' + newName.trim() + '"');
            }
        }

        function loadBoard() {
            const selectValue = document.getElementById('boardSelect').value;
            if (selectValue && boards[selectValue]) {
                currentBoardId = selectValue;
                renderGrid();
            }
        }

        function saveBoard() {
            if (!currentBoardId) {
                alert('Please create or select a board first');
                return;
            }
            
            console.log('Saving board:', currentBoardId, boards[currentBoardId]);
            saveToStorage();
            renderHistory();
            
            // Double-check the save worked
            const verification = localStorage.getItem('visionBoardData');
            if (verification) {
                const parsed = JSON.parse(verification);
                if (parsed.boards && parsed.boards[currentBoardId]) {
                    alert('Board saved successfully!\n\nBoard: ' + boards[currentBoardId].name + '\nImages: ' + boards[currentBoardId].images.length);
                } else {
                    alert('Warning: Save may have failed. Check console.');
                }
            } else {
                alert('Error: Could not verify save!');
            }
        }

        function deleteBoard() {
            if (!currentBoardId) {
                alert('No board selected');
                return;
            }
            
            const boardName = boards[currentBoardId].name;
            if (confirm('Are you sure you want to delete board "' + boardName + '"?')) {
                delete boards[currentBoardId];
                
                historyRows.forEach(row => {
                    if (row.boardId === currentBoardId) {
                        row.boardId = null;
                    }
                });
                
                currentBoardId = null;
                document.getElementById('boardSelect').value = '';
                saveToStorage();
                updateBoardSelect();
                renderHistory();
                renderGrid();
                alert('Board deleted');
            }
        }

        function addImages(event) {
            if (!currentBoardId) {
                alert('Please create or select a board first');
                event.target.value = '';
                return;
            }

            const files = event.target.files;
            if (!files || files.length === 0) {
                return;
            }

            if (!boards[currentBoardId].images) {
                boards[currentBoardId].images = [];
            }

            let loadedCount = 0;
            const totalFiles = files.length;
            let compressionErrors = 0;

            alert('Compressing ' + totalFiles + ' image(s)...');

            Array.from(files).forEach((file) => {
                compressImage(file, 800, 0.7).then((compressedDataUrl) => {
                    boards[currentBoardId].images.push(compressedDataUrl);
                    loadedCount++;
                    
                    if (loadedCount === totalFiles) {
                        try {
                            saveToStorage();
                            renderGrid();
                            renderHistory();
                            console.log('All images compressed and saved. Total images:', boards[currentBoardId].images.length);
                            alert('Successfully added ' + totalFiles + ' image(s)!\n\nStorage used: ' + getStorageUsageMB() + ' MB');
                        } catch (e) {
                            if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
                                alert('ERROR: Storage full!\n\nYou need to:\n1. Delete some boards or images\n2. Use fewer/smaller images\n\nStorage used: ' + getStorageUsageMB() + ' MB');
                                // Remove the images we just tried to add
                                for (let i = 0; i < totalFiles; i++) {
                                    boards[currentBoardId].images.pop();
                                }
                                renderGrid();
                            } else {
                                alert('Error saving: ' + e.message);
                            }
                        }
                    }
                }).catch((error) => {
                    console.error('Error compressing image:', error);
                    compressionErrors++;
                    loadedCount++;
                    
                    if (loadedCount === totalFiles) {
                        if (compressionErrors < totalFiles) {
                            saveToStorage();
                            renderGrid();
                            renderHistory();
                            alert('Added ' + (totalFiles - compressionErrors) + ' of ' + totalFiles + ' images.\n' + compressionErrors + ' failed to compress.');
                        } else {
                            alert('Failed to compress all images. Please try different images.');
                        }
                    }
                });
            });

            event.target.value = '';
        }

        function renderGrid() {
            const grid = document.getElementById('visionGrid');
            grid.innerHTML = '';
            
            const btn = document.createElement('button');
            btn.className = 'fullscreen-board-btn';
            btn.innerHTML = '⛶';
            btn.onclick = showFullscreenVision;
            grid.appendChild(btn);

            if (currentBoardId && boards[currentBoardId] && boards[currentBoardId].images) {
                console.log('Rendering grid - Board:', currentBoardId, 'Images:', boards[currentBoardId].images.length);
                boards[currentBoardId].images.forEach((imageSrc, index) => {
                    const item = createGridItem(imageSrc, index, true);
                    grid.appendChild(item);
                });
            } else {
                console.log('No images to render');
            }
            
            selectedImageIndex = -1;
        }

        function showFullscreenVision() {
            const overlay = document.getElementById('fullscreenOverlay');
            const grid = document.getElementById('fullscreenGrid');
            grid.innerHTML = '';
            
            if (currentBoardId && boards[currentBoardId] && boards[currentBoardId].images) {
                boards[currentBoardId].images.forEach((imageSrc, index) => {
                    const item = document.createElement('div');
                    item.className = 'grid-item';
                    
                    let touchStartTime;
                    let touchMoved = false;
                    
                    item.addEventListener('touchstart', function(e) {
                        touchStartTime = Date.now();
                        touchMoved = false;
                    }, {passive: true});
                    
                    item.addEventListener('touchmove', function(e) {
                        touchMoved = true;
                    }, {passive: true});
                    
                    item.addEventListener('touchend', function(e) {
                        const touchDuration = Date.now() - touchStartTime;
                        if (!touchMoved && touchDuration < 300) {
                            e.preventDefault();
                            showImageFullscreen(imageSrc);
                        }
                    });
                    
                    item.onclick = function(e) {
                        e.preventDefault();
                        showImageFullscreen(imageSrc);
                    };
                    
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    item.appendChild(img);
                    grid.appendChild(item);
                });
            }
            
            document.body.classList.add('fullscreen-active');
            overlay.classList.add('active');
        }

        function closeFullscreenVision() {
            document.getElementById('fullscreenOverlay').classList.remove('active');
            document.body.classList.remove('fullscreen-active');
        }

        function showImageFullscreen(imageSrc) {
            const overlay = document.getElementById('imageFullscreenOverlay');
            const img = document.getElementById('imageFullscreenImg');
            img.src = imageSrc;
            overlay.classList.add('active');
        }

        function closeImageFullscreen() {
            document.getElementById('imageFullscreenOverlay').classList.remove('active');
        }

        function createGridItem(imageSrc, index, interactive) {
            const item = document.createElement('div');
            item.className = 'grid-item';
            item.dataset.index = index;
            
            const img = document.createElement('img');
            img.src = imageSrc;
            item.appendChild(img);
            
            if (interactive) {
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    removeImage(index);
                };
                item.appendChild(deleteBtn);

                const moveLeftBtn = document.createElement('div');
                moveLeftBtn.className = 'move-left-btn';
                moveLeftBtn.innerHTML = '←';
                moveLeftBtn.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    moveImage(index, -1);
                };
                item.appendChild(moveLeftBtn);

                const moveRightBtn = document.createElement('div');
                moveRightBtn.className = 'move-right-btn';
                moveRightBtn.innerHTML = '→';
                moveRightBtn.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    moveImage(index, 1);
                };
                item.appendChild(moveRightBtn);

                let touchStartTime;
                let touchMoved = false;
                
                item.addEventListener('touchstart', function(e) {
                    touchStartTime = Date.now();
                    touchMoved = false;
                }, {passive: true});
                
                item.addEventListener('touchmove', function(e) {
                    touchMoved = true;
                }, {passive: true});
                
                item.addEventListener('touchend', function(e) {
                    if (e.target === deleteBtn || e.target === moveLeftBtn || e.target === moveRightBtn) {
                        return;
                    }
                    
                    const touchDuration = Date.now() - touchStartTime;
                    if (!touchMoved && touchDuration < 300) {
                        document.querySelectorAll('#visionGrid .grid-item').forEach(i => i.classList.remove('selected'));
                        
                        if (selectedImageIndex === index) {
                            selectedImageIndex = -1;
                        } else {
                            item.classList.add('selected');
                            selectedImageIndex = index;
                        }
                    }
                });
                
                item.onclick = function(e) {
                    if (e.target === deleteBtn || e.target === moveLeftBtn || e.target === moveRightBtn) return;
                    
                    document.querySelectorAll('#visionGrid .grid-item').forEach(i => i.classList.remove('selected'));
                    
                    if (selectedImageIndex === index) {
                        selectedImageIndex = -1;
                    } else {
                        this.classList.add('selected');
                        selectedImageIndex = index;
                    }
                };
            }
            
            return item;
        }

        function moveImage(currentIndex, direction) {
            if (!currentBoardId || !boards[currentBoardId]) return;
            
            const images = boards[currentBoardId].images;
            const newIndex = currentIndex + direction;
            
            if (newIndex < 0 || newIndex >= images.length) return;
            
            const temp = images[currentIndex];
            images[currentIndex] = images[newIndex];
            images[newIndex] = temp;
            
            selectedImageIndex = newIndex;
            
            saveToStorage();
            renderGrid();
            renderHistory();
            
            setTimeout(() => {
                const items = document.querySelectorAll('#visionGrid .grid-item');
                if (items[newIndex]) {
                    items[newIndex].classList.add('selected');
                }
            }, 10);
        }

        function removeImage(index) {
            if (currentBoardId && boards[currentBoardId]) {
                if (confirm('Delete this image?')) {
                    boards[currentBoardId].images.splice(index, 1);
                    saveToStorage();
                    renderGrid();
                    renderHistory();
                }
            }
        }

        function addHistoryRow() {
            const row = {
                id: 'row_' + Date.now(),
                ageFrom: 1,
                ageTo: 10,
                boardId: null
            };
            historyRows.push(row);
            saveToStorage();
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('historyContainer');
            container.innerHTML = '';

            historyRows.forEach((row, index) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'history-row';

                const ageCol = document.createElement('div');
                ageCol.className = 'history-col-age';
                
                const ageInputs = document.createElement('div');
                ageInputs.className = 'age-inputs';
                
                const fromGroup = document.createElement('div');
                fromGroup.className = 'age-input-group';
                const fromLabel = document.createElement('label');
                fromLabel.textContent = 'From Age';
                const fromInput = document.createElement('input');
                fromInput.type = 'number';
                fromInput.min = '1';
                fromInput.max = '230';
                fromInput.value = row.ageFrom;
                fromInput.onchange = function() {
                    row.ageFrom = parseInt(this.value);
                    saveToStorage();
                };
                fromGroup.appendChild(fromLabel);
                fromGroup.appendChild(fromInput);
                
                const toGroup = document.createElement('div');
                toGroup.className = 'age-input-group';
                const toLabel = document.createElement('label');
                toLabel.textContent = 'To Age';
                const toInput = document.createElement('input');
                toInput.type = 'number';
                toInput.min = '1';
                toInput.max = '230';
                toInput.value = row.ageTo;
                toInput.onchange = function() {
                    row.ageTo = parseInt(this.value);
                    saveToStorage();
                };
                toGroup.appendChild(toLabel);
                toGroup.appendChild(toInput);
                
                ageInputs.appendChild(fromGroup);
                ageInputs.appendChild(toGroup);
                ageCol.appendChild(ageInputs);

                const imageCol = document.createElement('div');
                imageCol.className = 'history-col-images';
                
                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid-container history-grid';
                gridDiv.onclick = function() {
                    openBoardSelection(index);
                };

                if (row.boardId && boards[row.boardId]) {
                    const board = boards[row.boardId];
                    board.images.forEach((imageSrc, imgIndex) => {
                        const item = createGridItem(imageSrc, imgIndex, false);
                        gridDiv.appendChild(item);
                    });
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.style.gridColumn = '1 / -1';
                    placeholder.style.display = 'flex';
                    placeholder.style.alignItems = 'center';
                    placeholder.style.justifyContent = 'center';
                    placeholder.style.color = '#666';
                    placeholder.style.fontSize = '14px';
                    placeholder.textContent = 'Tap to select board';
                    gridDiv.appendChild(placeholder);
                }

                imageCol.appendChild(gridDiv);

                rowDiv.appendChild(ageCol);
                rowDiv.appendChild(imageCol);
                
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'history-row-delete';
                deleteBtn.innerHTML = '×';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    deleteHistoryRow(index);
                };
                rowDiv.appendChild(deleteBtn);
                
                container.appendChild(rowDiv);
            });
        }

        function deleteHistoryRow(index) {
            if (confirm('Delete this row?')) {
                historyRows.splice(index, 1);
                saveToStorage();
                renderHistory();
            }
        }

        function openBoardSelection(rowIndex) {
            currentEditingRowIndex = rowIndex;
            updateBoardSelect();
            
            const row = historyRows[rowIndex];
            if (row.boardId) {
                document.getElementById('historyBoardSelect').value = row.boardId;
            }
            
            document.getElementById('selectBoardModal').classList.add('active');
        }

        function closeSelectBoardModal() {
            document.getElementById('selectBoardModal').classList.remove('active');
            currentEditingRowIndex = null;
        }

        function confirmBoardSelection() {
            if (currentEditingRowIndex === null) return;

            const selectValue = document.getElementById('historyBoardSelect').value;

            if (selectValue) {
                historyRows[currentEditingRowIndex].boardId = selectValue;
                saveToStorage();
                renderHistory();
                closeSelectBoardModal();
            } else {
                alert('Please select a board');
            }
        }

        init();
    </script>
</body>
</html>
