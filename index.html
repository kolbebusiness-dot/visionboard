<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vision Board App</title>
    <link rel="apple-touch-icon" href="icon.jpg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            position: relative;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000;
            color: #fff;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 60px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .hamburger {
            width: 30px;
            height: 25px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .hamburger span {
            width: 100%;
            height: 3px;
            background: #fff;
            transition: 0.3s;
        }

        .side-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            max-width: 80vw;
            height: 100vh;
            background: rgba(30, 30, 30, 0.98);
            backdrop-filter: blur(10px);
            transition: 0.3s;
            z-index: 200;
            padding-top: 80px;
            border-left: 1px solid #444;
        }

        .side-menu.active {
            right: 0;
        }

        .menu-item {
            padding: 20px 30px;
            cursor: pointer;
            transition: 0.2s;
            border-bottom: 1px solid #444;
            font-size: 18px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 150;
        }

        .overlay.active {
            display: block;
        }

        .main-content {
            padding-top: 80px;
            min-height: 100vh;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        .page {
            display: none;
            width: 100%;
        }

        .page.active {
            display: block;
        }

        .controls {
            padding: 15px;
            background: rgba(30, 30, 30, 0.8);
            margin: 15px;
            border-radius: 10px;
            width: calc(100% - 30px);
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #aaa;
        }

        select, input[type="text"], input[type="number"], button {
            width: 100%;
            padding: 12px;
            background: rgba(50, 50, 50, 0.9);
            border: 1px solid #555;
            color: #fff;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        button {
            background: #4a90e2;
            cursor: pointer;
            transition: 0.2s;
            border: none;
        }

        button:hover, button:active {
            background: #5aa0f2;
        }

        button.delete {
            background: #e24a4a;
        }

        button.delete:hover, button.delete:active {
            background: #f25a5a;
        }

        .collage-wrapper {
            position: relative;
            width: calc(100% - 30px);
            margin: 15px;
        }

        .collage-container {
            position: relative;
            width: 100%;
            height: 60vh;
            background: #000;
            border: 2px solid #333;
            border-radius: 10px;
            overflow: hidden;
            touch-action: none;
            cursor: grab;
        }

        .collage-container:active {
            cursor: grabbing;
        }

        .collage-canvas {
            position: absolute;
            width: 200%;
            height: 200%;
            min-width: 200%;
            min-height: 200%;
            touch-action: none;
            left: 0;
            top: 0;
        }

        .fullscreen-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 45px;
            height: 45px;
            background: rgba(74, 144, 226, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            font-size: 20px;
        }

        .fullscreen-mode .fullscreen-btn {
            font-size: 24px;
        }

        .fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            z-index: 500;
            background: #000;
            margin: 0;
            border-radius: 0;
        }

        .fullscreen-mode .collage-container {
            height: 100vh;
            border: none;
            border-radius: 0;
        }

        .collage-image {
            position: absolute;
            cursor: move;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            transition: box-shadow 0.2s;
            touch-action: none;
        }

        .collage-image.selected {
            box-shadow: 0 0 0 3px #4a90e2;
        }

        .collage-image.dragging {
            z-index: 100 !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .collage-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        .collage-image .rotate-handle {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: #4a90e2;
            border-radius: 50%;
            cursor: grab;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            touch-action: none;
        }

        .collage-image.selected .rotate-handle {
            display: flex;
        }

        .collage-image .rotate-handle:active {
            cursor: grabbing;
        }

        .collage-image .delete-btn {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 35px;
            height: 35px;
            background: #e24a4a;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            line-height: 1;
        }

        .collage-image.selected .delete-btn {
            display: flex;
        }

        .history-container {
            padding: 15px;
            width: 100%;
        }

        .history-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(30, 30, 30, 0.8);
            padding: 15px;
            border-radius: 10px;
            width: 100%;
        }

        .history-col-age {
            flex: 3;
            min-width: 0;
        }

        .history-col-images {
            flex: 9;
            min-width: 0;
        }

        .age-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .age-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .age-input-group label {
            font-size: 12px;
            color: #aaa;
        }

        .age-input-group input {
            margin-bottom: 0;
        }

        .history-collage {
            width: 100%;
            height: 200px;
            background: #000;
            border: 1px solid #555;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            pointer-events: none;
        }

        .history-collage:hover, .history-collage:active {
            border-color: #4a90e2;
        }
        
        .history-collage-wrapper {
            pointer-events: auto;
            cursor: pointer;
        }

        .history-collage-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 14px;
        }

        .add-row-btn {
            margin: 15px;
            width: calc(100% - 30px);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 10px;
            max-width: 90vw;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #aaa;
        }

        .close-modal:hover {
            color: #fff;
        }

        input[type="file"] {
            width: 100%;
            padding: 10px;
            background: rgba(50, 50, 50, 0.9);
            border: 1px solid #555;
            color: #fff;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .row-delete-btn {
            margin-top: 10px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="pageTitle">Vision Board</h1>
        <div class="hamburger" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <div class="side-menu" id="sideMenu">
        <div class="menu-item" onclick="navigateTo('vision')">Vision</div>
        <div class="menu-item" onclick="navigateTo('history')">History</div>
    </div>

    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

    <div class="main-content">
        <div class="page active" id="visionPage">
            <div class="controls">
                <div class="control-group">
                    <label>Select Collage</label>
                    <select id="collageSelect" onchange="loadCollage()">
                        <option value="">Select a collage...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Collage Name</label>
                    <input type="text" id="collageName" placeholder="Enter collage name">
                </div>
                <div class="control-group">
                    <label>Add Images</label>
                    <input type="file" id="imageUpload" accept="image/*" multiple onchange="addImages(event)">
                </div>
                <button onclick="saveCollage()">Save Collage</button>
                <button onclick="createNewCollage()">Create New Collage</button>
                <button class="delete" onclick="deleteCollage()">Delete Current Collage</button>
            </div>
            <div class="collage-wrapper" id="collageWrapper">
                <div class="collage-container" id="collageContainer">
                    <div class="collage-canvas" id="collageCanvas"></div>
                </div>
                <div class="fullscreen-btn" id="fullscreenBtn" onclick="enterFullscreen()">⛶</div>
            </div>
        </div>

        <div class="page" id="historyPage">
            <div class="controls">
                <h2>History Timeline</h2>
            </div>
            <div class="history-container" id="historyContainer"></div>
            <button class="add-row-btn" onclick="addHistoryRow()">Add New Row</button>
        </div>
    </div>

    <div class="modal" id="selectCollageModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSelectCollageModal()">&times;</span>
            <h2>Select or Create Collage</h2>
            <div class="control-group">
                <label>Choose Existing Collage</label>
                <select id="historyCollageSelect">
                    <option value="">Create new collage...</option>
                </select>
            </div>
            <div class="control-group">
                <label>Or Create New Collage</label>
                <input type="text" id="newHistoryCollageName" placeholder="New collage name">
            </div>
            <button onclick="confirmCollageSelection()">Continue</button>
            <button onclick="closeSelectCollageModal()">Cancel</button>
        </div>
    </div>

    <script>
        let collages = {};
        let currentCollageId = null;
        let historyRows = [];
        let draggedElement = null;
        let selectedElement = null;
        let isDragging = false;
        let isRotating = false;
        let isScaling = false;
        let isCanvasDragging = false;
        let isCanvasScaling = false;
        let startX = 0;
        let startY = 0;
        let startLeft = 0;
        let startTop = 0;
        let startWidth = 0;
        let startHeight = 0;
        let startDistance = 0;
        let rotateStartAngle = 0;
        let currentRotation = 0;
        let currentEditingRowIndex = null;
        let canvasX = 0;
        let canvasY = 0;
        let canvasScale = 1;
        let isFullscreen = false;
        let touchStartDistance = 0;
        let initialScale = 1;
        let initialWidth = 0;

        function init() {
            loadFromStorage();
            updateCollageSelect();
            renderHistory();
            
            let visionboardId = null;
            for (let id in collages) {
                if (collages[id].name === 'Visionboard') {
                    visionboardId = id;
                    break;
                }
            }
            
            if (!visionboardId) {
                visionboardId = 'collage_' + Date.now();
                collages[visionboardId] = {
                    name: 'Visionboard',
                    images: []
                };
                saveToStorage();
            }
            
            currentCollageId = visionboardId;
            updateCollageSelect();
            document.getElementById('collageSelect').value = visionboardId;
            document.getElementById('collageName').value = 'Visionboard';
            
            if (collages[currentCollageId].canvasX !== undefined) {
                canvasX = collages[currentCollageId].canvasX;
                canvasY = collages[currentCollageId].canvasY;
                canvasScale = collages[currentCollageId].canvasScale || 1;
            }
            
            loadCollage();
            setupTouchHandlers();
            setupCanvasHandlers();
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.collage-image') && selectedElement) {
                    deselectAll();
                }
            });
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('visionBoardData');
            if (saved) {
                const data = JSON.parse(saved);
                collages = data.collages || {};
                historyRows = data.historyRows || {};
            }
        }

        function saveToStorage() {
            localStorage.setItem('visionBoardData', JSON.stringify({
                collages: collages,
                historyRows: historyRows
            }));
        }

        function toggleMenu() {
            document.getElementById('sideMenu').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            if (page === 'vision') {
                document.getElementById('visionPage').classList.add('active');
                document.getElementById('pageTitle').textContent = 'Vision Board';
            } else if (page === 'history') {
                document.getElementById('historyPage').classList.add('active');
                document.getElementById('pageTitle').textContent = 'History';
                renderHistory();
            }
            
            toggleMenu();
        }

        function updateCollageSelect() {
            const select = document.getElementById('collageSelect');
            const historySelect = document.getElementById('historyCollageSelect');
            
            select.innerHTML = '<option value="">Select a collage...</option>';
            historySelect.innerHTML = '<option value="">Create new collage...</option>';
            
            Object.keys(collages).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = collages[id].name;
                select.appendChild(option);

                const historyOption = option.cloneNode(true);
                historySelect.appendChild(historyOption);
            });
        }

        function enterFullscreen() {
            if (isFullscreen) {
                exitFullscreen();
            } else {
                const wrapper = document.getElementById('collageWrapper');
                wrapper.classList.add('fullscreen-mode');
                document.getElementById('fullscreenBtn').innerHTML = '×';
                isFullscreen = true;
            }
        }

        function exitFullscreen() {
            const wrapper = document.getElementById('collageWrapper');
            wrapper.classList.remove('fullscreen-mode');
            document.getElementById('fullscreenBtn').innerHTML = '⛶';
            isFullscreen = false;
        }

        function deselectAll() {
            document.querySelectorAll('.collage-image').forEach(el => {
                el.classList.remove('selected');
            });
            selectedElement = null;
        }

        function selectImage(element) {
            deselectAll();
            element.classList.add('selected');
            selectedElement = element;
        }

        function createNewCollage() {
            const id = 'collage_' + Date.now();
            const name = prompt('Enter collage name:', 'New Collage');
            
            if (name) {
                collages[id] = {
                    name: name,
                    images: []
                };
                currentCollageId = id;
                updateCollageSelect();
                document.getElementById('collageSelect').value = id;
                document.getElementById('collageName').value = name;
                renderCollage();
                saveToStorage();
            }
        }

        function loadCollage() {
            const selectValue = document.getElementById('collageSelect').value;
            if (selectValue && collages[selectValue]) {
                currentCollageId = selectValue;
                document.getElementById('collageName').value = collages[currentCollageId].name;
                
                if (collages[currentCollageId].canvasX !== undefined) {
                    canvasX = collages[currentCollageId].canvasX;
                    canvasY = collages[currentCollageId].canvasY;
                    canvasScale = collages[currentCollageId].canvasScale || 1;
                } else {
                    canvasX = 0;
                    canvasY = 0;
                    canvasScale = 1;
                }
                
                const canvas = document.getElementById('collageCanvas');
                canvas.style.transform = `translate(${canvasX}px, ${canvasY}px) scale(${canvasScale})`;
                
                renderCollage();
            }
        }

        function saveCollage() {
            if (!currentCollageId) {
                alert('Please create or select a collage first');
                return;
            }

            const name = document.getElementById('collageName').value.trim();
            if (name) {
                collages[currentCollageId].name = name;
                collages[currentCollageId].canvasX = canvasX;
                collages[currentCollageId].canvasY = canvasY;
                collages[currentCollageId].canvasScale = canvasScale;
                updateCollageSelect();
                document.getElementById('collageSelect').value = currentCollageId;
                saveToStorage();
                renderHistory();
                alert('Collage saved!');
            }
        }

        function deleteCollage() {
            if (!currentCollageId) return;
            
            if (confirm('Are you sure you want to delete this collage?')) {
                delete collages[currentCollageId];
                
                historyRows.forEach(row => {
                    if (row.collageId === currentCollageId) {
                        row.collageId = null;
                    }
                });
                
                currentCollageId = null;
                document.getElementById('collageName').value = '';
                document.getElementById('collageCanvas').innerHTML = '';
                updateCollageSelect();
                saveToStorage();
                renderHistory();
            }
        }

        function addImages(event) {
            if (!currentCollageId) {
                alert('Please create or select a collage first');
                return;
            }

            const files = event.target.files;
            const canvas = document.getElementById('collageCanvas');
            const canvasWidth = canvas.offsetWidth;
            const canvasHeight = canvas.offsetHeight;

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        id: 'img_' + Date.now() + '_' + index,
                        src: e.target.result,
                        x: Math.random() * (canvasWidth - 200),
                        y: Math.random() * (canvasHeight - 200),
                        width: 120 + Math.random() * 80,
                        rotation: (Math.random() - 0.5) * 20
                    };

                    collages[currentCollageId].images.push(imageData);
                    createImageElement(imageData);
                    saveToStorage();
                    renderHistory();
                };
                reader.readAsDataURL(file);
            });

            event.target.value = '';
        }

        function renderCollage() {
            const canvas = document.getElementById('collageCanvas');
            canvas.innerHTML = '';

            if (currentCollageId && collages[currentCollageId]) {
                collages[currentCollageId].images.forEach(imageData => {
                    createImageElement(imageData);
                });
            }
        }

        function createImageElement(imageData) {
            const canvas = document.getElementById('collageCanvas');
            const div = document.createElement('div');
            div.className = 'collage-image';
            div.dataset.id = imageData.id;
            div.style.left = imageData.x + 'px';
            div.style.top = imageData.y + 'px';
            div.style.width = imageData.width + 'px';
            div.style.height = imageData.width + 'px';
            div.style.transform = `rotate(${imageData.rotation}deg)`;

            const img = document.createElement('img');
            img.src = imageData.src;
            
            const rotateHandle = document.createElement('div');
            rotateHandle.className = 'rotate-handle';
            rotateHandle.innerHTML = '↻';
            
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '×';
            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                removeImage(imageData.id);
            };

            div.appendChild(img);
            div.appendChild(rotateHandle);
            div.appendChild(deleteBtn);
            canvas.appendChild(div);
        }

        function setupCanvasHandlers() {
            const container = document.getElementById('collageContainer');
            const canvas = document.getElementById('collageCanvas');

            container.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    isCanvasScaling = true;
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    touchStartDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    initialScale = canvasScale;
                } else if (e.touches.length === 1 && 
                          !e.target.closest('.collage-image') && 
                          !e.target.closest('.fullscreen-btn')) {
                    isCanvasDragging = true;
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    startLeft = canvasX;
                    startTop = canvasY;
                }
            }, { passive: false });

            container.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2 && isCanvasScaling) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    canvasScale = Math.max(0.5, Math.min(3, initialScale * (currentDistance / touchStartDistance)));
                    canvas.style.transform = `translate(${canvasX}px, ${canvasY}px) scale(${canvasScale})`;
                    
                    if (currentCollageId) {
                        collages[currentCollageId].canvasScale = canvasScale;
                        saveToStorage();
                    }
                } else if (e.touches.length === 1 && isCanvasDragging) {
                    const deltaX = e.touches[0].clientX - startX;
                    const deltaY = e.touches[0].clientY - startY;
                    canvasX = startLeft + deltaX;
                    canvasY = startTop + deltaY;
                    canvas.style.transform = `translate(${canvasX}px, ${canvasY}px) scale(${canvasScale})`;
                }
            }, { passive: false });

            container.addEventListener('touchend', function(e) {
                if (e.touches.length < 2) {
                    isCanvasScaling = false;
                }
                if (e.touches.length === 0) {
                    isCanvasDragging = false;
                    
                    if (currentCollageId) {
                        collages[currentCollageId].canvasX = canvasX;
                        collages[currentCollageId].canvasY = canvasY;
                        saveToStorage();
                    }
                }
            });

            container.addEventListener('mousedown', function(e) {
                if (!e.target.closest('.collage-image') && 
                    !e.target.closest('.fullscreen-btn')) {
                    isCanvasDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startLeft = canvasX;
                    startTop = canvasY;
                    container.style.cursor = 'grabbing';
                }
            });

            document.addEventListener('mousemove', function(e) {
                if (isCanvasDragging) {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    canvasX = startLeft + deltaX;
                    canvasY = startTop + deltaY;
                    canvas.style.transform = `translate(${canvasX}px, ${canvasY}px) scale(${canvasScale})`;
                }
            });

            document.addEventListener('mouseup', function() {
                if (isCanvasDragging) {
                    isCanvasDragging = false;
                    container.style.cursor = 'grab';
                    
                    if (currentCollageId) {
                        collages[currentCollageId].canvasX = canvasX;
                        collages[currentCollageId].canvasY = canvasY;
                        saveToStorage();
                    }
                }
            });
        }

        function setupTouchHandlers() {
            document.addEventListener('mousedown', handleStart);
            document.addEventListener('touchstart', handleStart, { passive: false });
            
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('touchmove', handleMove, { passive: false });
            
            document.addEventListener('mouseup', handleEnd);
            document.addEventListener('touchend', handleEnd);
        }

        function handleStart(e) {
            const target = e.target;
            
            if (e.type === 'touchstart' && e.touches.length > 1) {
                return;
            }
            
            if (target.classList.contains('collage-image') || 
                target.closest('.collage-image')) {
                
                const collageImage = target.classList.contains('collage-image') ? 
                    target : target.closest('.collage-image');
                
                const rotateHandle = collageImage.querySelector('.rotate-handle');
                
                if (target === rotateHandle || target.closest('.rotate-handle')) {
                    e.preventDefault();
                    e.stopPropagation();
                    isRotating = true;
                    draggedElement = collageImage;
                    
                    const rect = collageImage.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                    
                    rotateStartAngle = Math.atan2(clientY - centerY, clientX - centerX);
                    
                    const transform = collageImage.style.transform;
                    const match = transform.match(/rotate\((.+?)deg\)/);
                    currentRotation = match ? parseFloat(match[1]) : 0;
                    
                } else if (!target.classList.contains('delete-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectImage(collageImage);
                    isDragging = true;
                    draggedElement = collageImage;
                    draggedElement.classList.add('dragging');
                    
                    const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                    
                    startX = clientX;
                    startY = clientY;
                    startLeft = parseInt(collageImage.style.left);
                    startTop = parseInt(collageImage.style.top);
                }
            }
        }

        function handleMove(e) {
            if (!draggedElement) return;
            
            if (e.type === 'touchmove' && e.touches.length === 2 && draggedElement && selectedElement) {
                e.preventDefault();
                if (!isScaling) {
                    isScaling = true;
                    isDragging = false;
                    isRotating = false;
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    touchStartDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    initialWidth = parseInt(draggedElement.style.width);
                }
                
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                const newWidth = Math.max(50, initialWidth * (currentDistance / touchStartDistance));
                draggedElement.style.width = newWidth + 'px';
                draggedElement.style.height = newWidth + 'px';
                return;
            }
            
            if (e.touches && e.touches.length > 1) return;
            
            const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
            
            if (isRotating) {
                e.preventDefault();
                const rect = draggedElement.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const angle = Math.atan2(clientY - centerY, clientX - centerX);
                const rotation = currentRotation + (angle - rotateStartAngle) * (180 / Math.PI);
                draggedElement.style.transform = `rotate(${rotation}deg)`;
                
            } else if (isDragging) {
                e.preventDefault();
                const deltaX = clientX - startX;
                const deltaY = clientY - startY;
                const newLeft = startLeft + deltaX;
                const newTop = startTop + deltaY;
                
                draggedElement.style.left = newLeft + 'px';
                draggedElement.style.top = newTop + 'px';
            }
        }

        function handleEnd(e) {
            if (draggedElement) {
                const id = draggedElement.dataset.id;
                const img = collages[currentCollageId].images.find(i => i.id === id);
                
                if (img) {
                    img.x = parseInt(draggedElement.style.left);
                    img.y = parseInt(draggedElement.style.top);
                    img.width = parseInt(draggedElement.style.width);
                    
                    const transform = draggedElement.style.transform;
                    const match = transform.match(/rotate\((.+?)deg\)/);
                    if (match) {
                        img.rotation = parseFloat(match[1]);
                    }
                    
                    saveToStorage();
                    renderHistory();
                }
                
                draggedElement.classList.remove('dragging');
                
                if (e && (isRotating || isScaling || isDragging)) {
                    const clientX = e.type === 'touchend' ? (e.changedTouches[0]?.clientX || startX) : e.clientX;
                    const clientY = e.type === 'touchend' ? (e.changedTouches[0]?.clientY || startY) : e.clientY;
                    
                    const rect = draggedElement.getBoundingClientRect();
                    const isOutside = clientX < rect.left || clientX > rect.right || 
                                     clientY < rect.top || clientY > rect.bottom;
                    
                    if (isOutside) {
                        deselectAll();
                    }
                }
                
                draggedElement = null;
                isDragging = false;
                isRotating = false;
                isScaling = false;
            }
        }

        function removeImage(imageId) {
            if (currentCollageId && collages[currentCollageId]) {
                collages[currentCollageId].images = collages[currentCollageId].images.filter(i => i.id !== imageId);
                renderCollage();
                saveToStorage();
                renderHistory();
            }
        }

        function addHistoryRow() {
            const row = {
                id: 'row_' + Date.now(),
                ageFrom: 1,
                ageTo: 10,
                collageId: null
            };
            historyRows.push(row);
            saveToStorage();
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('historyContainer');
            container.innerHTML = '';

            historyRows.forEach((row, index) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'history-row';

                const ageCol = document.createElement('div');
                ageCol.className = 'history-col-age';
                
                const ageInputs = document.createElement('div');
                ageInputs.className = 'age-inputs';
                
                const fromGroup = document.createElement('div');
                fromGroup.className = 'age-input-group';
                const fromLabel = document.createElement('label');
                fromLabel.textContent = 'From Age';
                const fromInput = document.createElement('input');
                fromInput.type = 'number';
                fromInput.min = '1';
                fromInput.max = '230';
                fromInput.value = row.ageFrom;
                fromInput.onchange = function() {
                    row.ageFrom = parseInt(this.value);
                    saveToStorage();
                };
                fromGroup.appendChild(fromLabel);
                fromGroup.appendChild(fromInput);
                
                const toGroup = document.createElement('div');
                toGroup.className = 'age-input-group';
                const toLabel = document.createElement('label');
                toLabel.textContent = 'To Age';
                const toInput = document.createElement('input');
                toInput.type = 'number';
                toInput.min = '1';
                toInput.max = '230';
                toInput.value = row.ageTo;
                toInput.onchange = function() {
                    row.ageTo = parseInt(this.value);
                    saveToStorage();
                };
                toGroup.appendChild(toLabel);
                toGroup.appendChild(toInput);
                
                ageInputs.appendChild(fromGroup);
                ageInputs.appendChild(toGroup);
                ageCol.appendChild(ageInputs);

                const imageCol = document.createElement('div');
                imageCol.className = 'history-col-images';
                
                const collageWrapper = document.createElement('div');
                collageWrapper.className = 'history-collage-wrapper';
                
                const collageDiv = document.createElement('div');
                collageDiv.className = 'history-collage';
                collageDiv.onclick = function() {
                    openCollageSelection(index);
                };

                if (row.collageId && collages[row.collageId]) {
                    const collage = collages[row.collageId];
                    collage.images.forEach((img, imgIndex) => {
                        const imgDiv = document.createElement('div');
                        imgDiv.style.position = 'absolute';
                        imgDiv.style.left = (img.x / 3) + 'px';
                        imgDiv.style.top = (img.y / 2) + 'px';
                        imgDiv.style.width = (img.width / 2) + 'px';
                        imgDiv.style.height = (img.width / 2) + 'px';
                        imgDiv.style.transform = `rotate(${img.rotation}deg)`;
                        imgDiv.style.zIndex = imgIndex;
                        imgDiv.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.5)';

                        const imgEl = document.createElement('img');
                        imgEl.src = img.src;
                        imgEl.style.width = '100%';
                        imgEl.style.height = '100%';
                        imgEl.style.objectFit = 'cover';
                        imgEl.style.pointerEvents = 'none';
                        imgDiv.appendChild(imgEl);
                        collageDiv.appendChild(imgDiv);
                    });
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'history-collage-placeholder';
                    placeholder.textContent = 'Tap to select collage';
                    collageDiv.appendChild(placeholder);
                }

                collageWrapper.appendChild(collageDiv);
                imageCol.appendChild(collageWrapper);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete Row';
                deleteBtn.className = 'delete row-delete-btn';
                deleteBtn.onclick = function() {
                    deleteHistoryRow(index);
                };

                rowDiv.appendChild(ageCol);
                rowDiv.appendChild(imageCol);
                container.appendChild(rowDiv);
                container.appendChild(deleteBtn);
            });
        }

        function deleteHistoryRow(index) {
            if (confirm('Delete this row?')) {
                historyRows.splice(index, 1);
                saveToStorage();
                renderHistory();
            }
        }

        function openCollageSelection(rowIndex) {
            currentEditingRowIndex = rowIndex;
            updateCollageSelect();
            
            const row = historyRows[rowIndex];
            if (row.collageId) {
                document.getElementById('historyCollageSelect').value = row.collageId;
            }
            
            document.getElementById('selectCollageModal').classList.add('active');
        }

        function closeSelectCollageModal() {
            document.getElementById('selectCollageModal').classList.remove('active');
            document.getElementById('newHistoryCollageName').value = '';
            currentEditingRowIndex = null;
        }

        function confirmCollageSelection() {
            if (currentEditingRowIndex === null) return;

            const selectValue = document.getElementById('historyCollageSelect').value;
            const newName = document.getElementById('newHistoryCollageName').value.trim();

            if (selectValue) {
                historyRows[currentEditingRowIndex].collageId = selectValue;
                saveToStorage();
                renderHistory();
                closeSelectCollageModal();
            } else if (newName) {
                const id = 'collage_' + Date.now();
                collages[id] = {
                    name: newName,
                    images: []
                };
                historyRows[currentEditingRowIndex].collageId = id;
                updateCollageSelect();
                saveToStorage();
                renderHistory();
                closeSelectCollageModal();
                
                currentCollageId = id;
                document.getElementById('collageSelect').value = id;
                document.getElementById('collageName').value = newName;
                navigateTo('vision');
            } else {
                alert('Please select a collage or enter a name for a new one');
            }
        }

        init();
    </script>
</body>
</html>
